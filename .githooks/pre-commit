#!/usr/bin/env bash
set -euo pipefail

# Format only staged C# files (added/modified)
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.cs$' || true)

# Nothing to do?
[ -z "${FILES}" ] && exit 0

# Ensure tools available (don’t fail the commit if restore fails)
dotnet tool restore > /dev/null 2>&1 || true

echo "[pre-commit] formatting staged C# files with CSharpier…"
# Normalize \r\n -> \n for xargs on Windows, then format each file
printf "%s\n" "${FILES}" | tr '\r' '\n' | while read -r f; do
  [ -f "$f" ] || continue
  dotnet csharpier "$f"
done

# Re-add formatted files to the index
git add ${FILES}
